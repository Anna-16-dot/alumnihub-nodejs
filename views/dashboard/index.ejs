<div class="container-fluid p-3">
    <!-- Welcome Section -->
    <div class="welcome-card mb-3">
        <h5 class="mb-1">Welcome back, <%= user.name %>! ðŸ‘‹</h5>
        <p class="text-white-50 small mb-0"><%- getRoleBadge(user.role) %></p>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-3">
        <div class="col-6">
            <a href="/directory" class="text-decoration-none">
                <div class="stat-card bg-primary">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-info">
                        <h3><%= stats.alumni %></h3>
                        <p>Alumni</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="/dashboard" class="text-decoration-none">
                <div class="stat-card bg-success">
                    <div class="stat-icon">
                        <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="stat-info">
                        <h3><%= stats.students %></h3>
                        <p>Students</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="/newsfeed" class="text-decoration-none">
                <div class="stat-card bg-info">
                    <div class="stat-icon">
                        <i class="bi bi-newspaper"></i>
                    </div>
                    <div class="stat-info">
                        <h3><%= stats.posts %></h3>
                        <p>Posts</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="/jobs" class="text-decoration-none">
                <div class="stat-card bg-warning">
                    <div class="stat-icon">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <div class="stat-info">
                        <h3><%= stats.jobs %></h3>
                        <p>Jobs</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-header mb-3">
        <h6 class="mb-0"><i class="bi bi-lightning-fill text-warning me-2"></i>Quick Actions</h6>
    </div>
    
    <div class="row g-3 mb-4">
        <div class="col-6">
            <a href="/directory" class="quick-action-card">
                <i class="bi bi-search-heart"></i>
                <span>Find Alumni</span>
            </a>
        </div>
        <div class="col-6">
            <a href="/jobs" class="quick-action-card">
                <i class="bi bi-briefcase-fill"></i>
                <span>Browse Jobs</span>
            </a>
        </div>
        <% if (user.role === 'alumni' || user.role === 'admin') { %>
        <div class="col-6">
            <a href="/newsfeed/create" class="quick-action-card">
                <i class="bi bi-pencil-square"></i>
                <span>Create Post</span>
            </a>
        </div>
        <div class="col-6">
            <a href="/jobs/create" class="quick-action-card">
                <i class="bi bi-megaphone-fill"></i>
                <span>Post Job</span>
            </a>
        </div>
        <% } %>
        <% if (user.role === 'admin') { %>
        <div class="col-6">
            <a href="/admin/users" class="quick-action-card">
                <i class="bi bi-people-fill"></i>
                <span>Manage Users</span>
            </a>
        </div>
        <% } %>
    </div>

    <!-- Recent Updates -->
    <div class="recent-updates-section">
        <div class="section-header-modern">
            <div class="section-title">
                <i class="bi bi-lightning-charge-fill"></i>
                <h5>Recent Updates</h5>
            </div>
            <a href="/newsfeed" class="view-all-btn">
                View All <i class="bi bi-arrow-right"></i>
            </a>
        </div>

        <% if (recentPosts && recentPosts.length > 0) { %>
            <% recentPosts.forEach(post => { %>
            <div class="modern-post-card">
                <div class="modern-post-header">
                    <div class="modern-post-author">
                        <% if (post.profile_picture) { %>
                            <img src="/<%= post.profile_picture %>" alt="Profile" class="modern-avatar">
                        <% } else { %>
                            <div class="modern-avatar-placeholder">
                                <%= post.name.charAt(0).toUpperCase() %>
                            </div>
                        <% } %>
                        <div class="modern-author-info">
                            <div class="author-name"><%= post.name %></div>
                            <div class="author-meta">
                                <%- getRoleBadge(post.role) %>
                                <span class="post-time"><i class="bi bi-clock"></i> <%= timeAgo(post.created_at) %></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modern-post-content">
                    <p><%= post.content.length > 200 ? post.content.substring(0, 200) + '...' : post.content %></p>
                    <% if (post.image) { %>
                        <div class="modern-post-image-wrapper">
                            <img src="/<%= post.image %>" alt="Post" class="modern-post-image">
                        </div>
                    <% } %>
                </div>
                <div class="modern-post-footer">
                    <button class="modern-action-btn like-btn-dashboard <%= post.user_liked ? 'liked' : '' %>" onclick="likePostDashboard(<%= post.id %>)" data-post-id="<%= post.id %>">
                        <i class="bi <%= post.user_liked ? 'bi-heart-fill text-danger' : 'bi-heart' %>"></i>
                        <span class="like-count-dashboard"><%= post.likes_count || 0 %></span>
                    </button>
                    <button class="modern-action-btn" onclick="toggleCommentBoxDashboard(<%= post.id %>)">
                        <i class="bi bi-chat-dots"></i>
                        <span>Comment</span>
                    </button>
                    <button class="modern-action-btn" onclick="sharePostDashboard(<%= post.id %>)">
                        <i class="bi bi-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                <!-- Comments Section -->
                <div class="comments-section" id="commentsSection<%= post.id %>" style="display: none;">
                    <div class="comments-list" id="commentsList<%= post.id %>">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div class="comment-box" id="commentBoxDashboard<%= post.id %>">
                        <textarea class="form-control mb-2" placeholder="Write a comment..." id="commentTextDashboard<%= post.id %>" rows="2"></textarea>
                        <button class="btn btn-primary btn-sm w-100" onclick="addCommentDashboard(<%= post.id %>)">
                            <i class="bi bi-send-fill me-1"></i>Post Comment
                        </button>
                    </div>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <div class="modern-empty-state">
                <div class="empty-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h6>No Updates Yet</h6>
                <p>Check back later for new posts from alumni</p>
                <a href="/newsfeed" class="btn btn-primary btn-sm mt-2">
                    <i class="bi bi-plus-circle me-1"></i>Explore Newsfeed
                </a>
            </div>
        <% } %>
    </div>
</div>

<script>
function likePostDashboard(postId) {
    const btn = document.querySelector(`.like-btn-dashboard[data-post-id="${postId}"]`);
    const icon = btn.querySelector('i');
    const likeCount = btn.querySelector('.like-count-dashboard');
    
    fetch('/api/like-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: postId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update count
            likeCount.textContent = data.likes_count;
            
            // Toggle heart icon and color
            if (data.liked) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill', 'text-danger');
                btn.classList.add('liked');
            } else {
                icon.classList.remove('bi-heart-fill', 'text-danger');
                icon.classList.add('bi-heart');
                btn.classList.remove('liked');
            }
            
            if (typeof loadNotificationCount === 'function') loadNotificationCount();
        }
    })
    .catch(error => {
        console.error('Like error:', error);
    });
}

function toggleCommentBoxDashboard(postId) {
    const commentsSection = document.getElementById(`commentsSection${postId}`);
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        loadCommentsDashboard(postId);
    } else {
        commentsSection.style.display = 'none';
    }
}

function loadCommentsDashboard(postId) {
    fetch(`/api/get-comments/${postId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const commentsList = document.getElementById(`commentsList${postId}`);
                if (data.comments.length === 0) {
                    commentsList.innerHTML = '<p class="text-muted small mb-3">No comments yet. Be the first to comment!</p>';
                } else {
                    commentsList.innerHTML = data.comments.map(comment => `
                        <div class="comment-item" id="comment${comment.id}">
                            <div class="comment-header">
                                <strong>${comment.name}</strong>
                                <small class="text-muted">${timeAgoDashboard(comment.created_at)}</small>
                            </div>
                            <div class="comment-body">${escapeHtmlDashboard(comment.comment)}</div>
                            ${canDeleteCommentDashboard(comment.user_id) ? `
                                <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteCommentDashboard(${comment.id}, ${postId})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            ` : ''}
                        </div>
                    `).join('');
                }
            }
        });
}

function canDeleteCommentDashboard(commentUserId) {
    return commentUserId === <%= user.id %> || '<%= user.role %>' === 'admin';
}

function escapeHtmlDashboard(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function timeAgoDashboard(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const seconds = Math.floor((now - past) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function addCommentDashboard(postId) {
    const commentText = document.getElementById('commentTextDashboard' + postId).value.trim();
    if (!commentText) {
        alert('Please write a comment');
        return;
    }
    fetch('/api/add-comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: postId, comment: commentText })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('commentTextDashboard' + postId).value = '';
            loadCommentsDashboard(postId);
            if (typeof loadNotificationCount === 'function') loadNotificationCount();
        }
    });
}

function deleteCommentDashboard(commentId, postId) {
    if (!confirm('Are you sure you want to delete this comment?')) return;

    fetch(`/api/delete-comment/${commentId}`, {
        method: 'DELETE'
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                loadCommentsDashboard(postId);
            } else {
                alert(data.message || 'Failed to delete comment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
}

function sharePostDashboard(postId) {
    if (confirm('Share this post?')) {
        fetch('/api/share-post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ post_id: postId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Post shared successfully!');
                if (typeof loadNotificationCount === 'function') loadNotificationCount();
            }
        });
    }
}
</script>
